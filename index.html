<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Rastreador de Trajeto - Navega√ß√£o em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

  <!-- Leaflet CSS (CDN oficial) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f5f5f5;
      overflow: hidden;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100vh;
    }

    .map-container {
      flex: 1;
      position: relative;
      background: #e0e0e0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .location-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .location-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
    }

    .sidebar {
      width: 360px;
      background: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-left: 1px solid #e0e0e0;
    }

    .sidebar-header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar-header h1 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .sidebar-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .alert {
      display: none;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 10px;
    }

    .alert.show {
      display: block;
    }

    .alert-info {
      background: #e8f4ff;
      border: 1px solid #66a3ff;
      color: #1a4f8b;
    }

    .alert-success {
      background: #e6ffed;
      border: 1px solid #34c759;
      color: #0b5e27;
    }

    .alert-error {
      background: #ffe6e6;
      border: 1px solid #ff4d4f;
      color: #a8071a;
    }

    .status-badge {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      width: 100%;
      text-align: center;
      margin-bottom: 15px;
    }

    .status-aguardando {
      background: #fff3cd;
      color: #856404;
    }

    .status-ativo {
      background: #d4edda;
      color: #155724;
    }

    .status-parado {
      background: #f8d7da;
      color: #721c24;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .button-group.full {
      grid-template-columns: 1fr;
    }

    .btn {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s;
    }

    .btn-iniciar {
      background: linear-gradient(135deg, #00d084 0%, #00a86b 100%);
      color: white;
      grid-column: 1 / -1;
    }

    .btn-parar {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: white;
    }

    .btn-info {
      background: #667eea;
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      border: 2px solid #e0e0e0;
    }

    .btn-warning {
      background: #ffa500;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .divider {
      height: 1px;
      background: #e0e0e0;
      margin: 15px 0;
    }

    .info-panel {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #00d4ff;
    }

    .info-panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 5px;
    }

    .info-panel p {
      font-size: 16px;
      font-weight: bold;
      color: #1e3c72;
      word-break: break-all;
    }

    .info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #1e3c72;
    }

    /* Rota Atual */
    .current-route-section {
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .current-route-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: #1e3c72;
    }

    .current-route-container {
      background: #d4edda;
      border: 1px solid #34c759;
      border-radius: 6px;
      padding: 10px;
      display: block;
    }

    .current-route-container.hidden {
      display: none;
    }

    .current-route-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .current-route-meta {
      font-size: 12px;
      color: #0b5e27;
    }

    .current-route-distance,
    .current-route-time,
    .current-route-points {
      line-height: 1.6;
    }

    .current-route-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .btn-current-view {
      background: #00d084;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-current-view:hover {
      background: #00a86b;
      transform: scale(0.95);
    }

    .btn-current-delete {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-current-delete:hover {
      background: #ee5a6f;
      transform: scale(0.95);
    }

    .current-route-empty {
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
    }

    /* Hist√≥rico */
    .history-section {
      margin-top: 15px;
      border-top: 2px solid #e0e0e0;
      padding-top: 10px;
    }

    .history-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-count {
      font-size: 11px;
      background: #667eea;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
    }

    .history-list {
      max-height: 180px;
      overflow-y: auto;
    }

    .history-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .history-name-input {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #d0d0d0;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .history-meta {
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
    }

    .history-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .btn-history-view {
      background: #667eea;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-history-delete {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .history-empty {
      font-size: 12px;
      color: #999;
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .map-container {
        height: 50%;
      }
      .sidebar {
        width: 100%;
        height: 50%;
      }
      .button-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-container">
      <div id="map"></div>
      <button class="location-button" id="btnCentralizar" title="Centralizar na localiza√ß√£o">üìç</button>
    </div>

    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üöó Rastreador de Trajeto</h1>
        <p>Tra√ßado em tempo real (GPS bruto)</p>
      </div>

      <div class="sidebar-content">
        <div id="alerta" class="alert alert-info"></div>

        <div id="statusBadge" class="status-badge status-aguardando">
          ‚è≥ Aguardando GPS...
        </div>

        <div class="form-group">
          <label>üìç Buscar endere√ßo (ou clique no mapa)</label>
          <input type="text" id="inputEndereco" placeholder="Ex: Rua das Flores, Porto Alegre" />
        </div>

        <div class="button-group full">
          <button class="btn btn-iniciar" id="btnIniciar">‚ñ∂ Iniciar rastreamento</button>
          <button class="btn btn-info" id="btnNavegar">üß≠ Navegar at√© destino</button>
        </div>

        <div class="button-group">
          <button class="btn btn-parar" id="btnParar" disabled>‚èπ Parar</button>
          <button class="btn btn-secondary" id="btnLimparDestino">‚úï Limpar destino</button>
        </div>

        <div class="button-group">
          <button class="btn btn-warning" id="btnLimparTrajeto">üóë Limpar trajeto</button>
          <button class="btn btn-info" id="btnIrLocalizacao">üìç Ir para localiza√ß√£o atual</button>
        </div>

        <div class="divider"></div>

        <div class="info-panel">
          <h3>Latitude</h3>
          <p id="latitude">--</p>
        </div>

        <div class="info-panel">
          <h3>Longitude</h3>
          <p id="longitude">--</p>
        </div>

        <div class="info-row">
          <div class="stat-card">
            <div class="stat-label">Dist√¢ncia</div>
            <div class="stat-value" id="distancia">0 km</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Tempo</div>
            <div class="stat-value" id="tempo">00:00</div>
          </div>
        </div>

        <div class="info-panel">
          <h3>Pontos Coletados</h3>
          <p id="pontos">0</p>
        </div>

        <div class="info-panel">
          <h3>Status GPS</h3>
          <p id="statusGPS">Desconectado</p>
        </div>

        <!-- ROTA ATUAL EM PROGRESSO -->
        <div class="current-route-section">
          <div class="current-route-title">üöó Rota Atual</div>
          <div id="currentRouteContainer" class="current-route-container hidden">
            <div class="current-route-info">
              <div class="current-route-meta">
                <div class="current-route-distance">üìç <span id="currentRouteDist">0</span> km</div>
                <div class="current-route-time">‚è±Ô∏è <span id="currentRouteTime">00:00</span></div>
                <div class="current-route-points">üìå <span id="currentRoutePoints">0</span> pontos</div>
              </div>
              <div class="current-route-buttons">
                <button class="btn-current-view" onclick="verRotaAtual()">üëÅ Ver</button>
                <button class="btn-current-delete" onclick="excluirRotaAtual()">üóë Excluir</button>
              </div>
            </div>
          </div>
          <div id="currentRouteEmpty" class="current-route-empty">Nenhuma rota em progresso</div>
        </div>

        <div class="divider"></div>

        <!-- HIST√ìRICO DE ROTAS -->
        <div class="history-section">
          <div class="history-title">
            üìã √öltimas rotas
            <span class="history-count" id="historyCount">0 / 5</span>
          </div>
          <div class="history-list" id="historyList">
            <div class="history-empty">Nenhuma rota registrada ainda</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    let map;
    let userMarker;
    let trajetoPolyline;
    let rotaPolyline;
    let destinoMarker;

    let rastreando = false;
    let watchId = null;
    let ultimaPosicao = null;
    let pontos = [];
    let distanciaTotal = 0;
    let inicioMs = null;
    let destino = null;

    let historicoRotas = [];
    let historyPolyline = null;

    const STORAGE_KEY = "rastreador_historico_5";
    const RASTREAMENTO_ATUAL_KEY = "rastreamento_atual";

    window.addEventListener("load", function () {
      inicializarMapa();
      configurarBotoes();
      carregarHistorico();
      verificarRastreamentoInterrompido();
    });

    window.addEventListener("beforeunload", function () {
      if (rastreando) salvarRastreamentoAtual();
    });

    function inicializarMapa() {
      map = L.map("map").setView([-30.0326, -51.2093], 15);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
        maxZoom: 19,
      }).addTo(map);

      trajetoPolyline = L.polyline([], {
        color: "#00d4ff",
        weight: 6,
        opacity: 0.95,
      }).addTo(map);

      rotaPolyline = L.polyline([], {
        color: "#9b59b6",
        weight: 4,
        opacity: 0.9,
      }).addTo(map);

      userMarker = L.circleMarker([-30.0326, -51.2093], {
        radius: 10,
        fillColor: "#00d084",
        color: "white",
        weight: 3,
        opacity: 1,
        fillOpacity: 1,
      }).addTo(map);

      destinoMarker = L.marker([-999, -999]).addTo(map);

      map.on("click", onMapClick);

      obterLocalizacaoInicial();
    }

    function configurarBotoes() {
      document.getElementById("btnIniciar").addEventListener("click", iniciarRastreamento);
      document.getElementById("btnParar").addEventListener("click", pararRastreamento);
      document.getElementById("btnNavegar").addEventListener("click", navegarParaDestino);
      document.getElementById("btnLimparDestino").addEventListener("click", limparDestino);
      document.getElementById("btnLimparTrajeto").addEventListener("click", limparTrajeto);

      document.getElementById("btnCentralizar").addEventListener("click", irParaLocalizacaoAtual);
      document.getElementById("btnIrLocalizacao").addEventListener("click", irParaLocalizacaoAtual);

      const input = document.getElementById("inputEndereco");
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          if (input.value.trim().length >= 3) {
            buscarEnderecoNominatim(input.value.trim());
          }
        }
      });
    }

    function irParaLocalizacaoAtual() {
      if (ultimaPosicao) {
        map.setView([ultimaPosicao.lat, ultimaPosicao.lng]);
      } else {
        mostrarAlerta("Localiza√ß√£o atual ainda n√£o obtida.", "error");
      }
    }

    function mostrarAlerta(msg, tipo) {
      const alerta = document.getElementById("alerta");
      alerta.className = "alert";
      if (tipo === "info") alerta.classList.add("alert-info");
      if (tipo === "success") alerta.classList.add("alert-success");
      if (tipo === "error") alerta.classList.add("alert-error");
      alerta.textContent = msg;
      alerta.classList.add("show");
    }

    function limparAlerta() {
      const alerta = document.getElementById("alerta");
      alerta.classList.remove("show");
    }

    function obterLocalizacaoInicial() {
      if (!navigator.geolocation) {
        mostrarAlerta("Navegador n√£o suporta geolocaliza√ß√£o.", "error");
        return;
      }

      mostrarAlerta("Obtendo localiza√ß√£o inicial...", "info");

      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const { latitude, longitude } = pos.coords;
          ultimaPosicao = { lat: latitude, lng: longitude };

          map.setView([latitude, longitude], 18);
          userMarker.setLatLng([latitude, longitude]);

          atualizarPosicaoUI(latitude, longitude);
          document.getElementById("statusGPS").textContent = "‚úÖ Conectado";
          const badge = document.getElementById("statusBadge");
          badge.textContent = "üü° Parado (pronto para rastrear)";
          badge.className = "status-badge status-aguardando";

          mostrarAlerta("Localiza√ß√£o inicial obtida. Pronto para rastrear.", "success");
          setTimeout(limparAlerta, 3000);
        },
        function () {
          mostrarAlerta("Erro ao obter localiza√ß√£o. Verifique as permiss√µes.", "error");
          document.getElementById("statusGPS").textContent = "‚ùå Sem GPS";
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function iniciarRastreamento() {
      if (!navigator.geolocation) {
        mostrarAlerta("Navegador n√£o suporta geolocaliza√ß√£o.", "error");
        return;
      }

      rastreando = true;
      pontos = [];
      distanciaTotal = 0;
      inicioMs = Date.now();

      document.getElementById("btnIniciar").disabled = true;
      document.getElementById("btnParar").disabled = false;
      const badge = document.getElementById("statusBadge");
      badge.textContent = "üü¢ Rastreando";
      badge.className = "status-badge status-ativo";
      mostrarAlerta("Rastreamento iniciado (GPS bruto).", "success");

      watchId = navigator.geolocation.watchPosition(
        function (pos) {
          const { latitude, longitude } = pos.coords;
          const novo = { lat: latitude, lng: longitude };

          if (!ultimaPosicao) {
            pontos.push(novo);
            ultimaPosicao = novo;
          } else {
            const d = calcularDistancia(ultimaPosicao, novo);
            // Captura a partir de ~0,2 m para curvas bem detalhadas
            if (d > 0.2) {
              distanciaTotal += d;
              pontos.push(novo);
              ultimaPosicao = novo;
            }
          }

          trajetoPolyline.setLatLngs(pontos);
          userMarker.setLatLng([latitude, longitude]);

          atualizarPosicaoUI(latitude, longitude);
          atualizarEstatisticasUI();
          document.getElementById("statusGPS").textContent = "‚úÖ Conectado";

          if (pontos.length % 20 === 0) salvarRastreamentoAtual();
        },
        function (err) {
          console.error("Erro GPS:", err);
          mostrarAlerta("Erro no GPS durante rastreamento.", "error");
        },
        { enableHighAccuracy: true, timeout: 2000, maximumAge: 0 }
      );

      atualizarTempoRastreamento();
      atualizarVisualizacaoRotaAtual();
    }

    function pararRastreamento() {
      rastreando = false;
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      document.getElementById("btnIniciar").disabled = false;
      document.getElementById("btnParar").disabled = true;
      const badge = document.getElementById("statusBadge");
      badge.textContent = "üü° Parado";
      badge.className = "status-badge status-parado";
      mostrarAlerta("Rastreamento parado e salvo no hist√≥rico.", "info");

      if (pontos.length > 1) salvarRotaNoHistorico();

      localStorage.removeItem(RASTREAMENTO_ATUAL_KEY);
      atualizarVisualizacaoRotaAtual();
    }

    function atualizarTempoRastreamento() {
      if (!rastreando || !inicioMs) return;
      const ms = Date.now() - inicioMs;
      document.getElementById("tempo").textContent = formatarTempo(ms);
      atualizarVisualizacaoRotaAtual();
      requestAnimationFrame(atualizarTempoRastreamento);
    }

    function atualizarPosicaoUI(lat, lng) {
      document.getElementById("latitude").textContent = lat.toFixed(6);
      document.getElementById("longitude").textContent = lng.toFixed(6);
    }

    function atualizarEstatisticasUI() {
      document.getElementById("distancia").textContent =
        (distanciaTotal / 1000).toFixed(3) + " km";
      document.getElementById("pontos").textContent = String(pontos.length);
    }

    function calcularDistancia(a, b) {
      const R = 6371000;
      const dLat = ((b.lat - a.lat) * Math.PI) / 180;
      const dLng = ((b.lng - a.lng) * Math.PI) / 180;
      const lat1 = (a.lat * Math.PI) / 180;
      const lat2 = (b.lat * Math.PI) / 180;

      const x =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1) * Math.cos(lat2) *
          Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
      return R * c;
    }

    function formatarTempo(ms) {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      const ss = String(s % 60).padStart(2, "0");
      const mm = String(m % 60).padStart(2, "0");
      const hh = String(h).padStart(2, "0");
      return h > 0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
    }

    function onMapClick(e) {
      destino = { lat: e.latlng.lat, lng: e.latlng.lng };
      destinoMarker.setLatLng(e.latlng);
      rotaPolyline.setLatLngs([]);
      mostrarAlerta(
        "Destino definido no mapa. Clique em 'Navegar at√© destino' para tra√ßar rota.",
        "info"
      );
    }

    function navegarParaDestino() {
      if (!destino) {
        mostrarAlerta("Selecione um destino clicando no mapa ou buscando endere√ßo.", "error");
        return;
      }
      if (!ultimaPosicao) {
        mostrarAlerta("Aguarde obter sua localiza√ß√£o atual.", "error");
        return;
      }

      const start = `${ultimaPosicao.lng},${ultimaPosicao.lat}`;
      const end = `${destino.lng},${destino.lat}`;
      const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;

      mostrarAlerta("Calculando rota pelas ruas...", "info");

      fetch(url)
        .then((r) => r.json())
        .then((data) => {
          if (!data.routes || !data.routes[0]) {
            mostrarAlerta("N√£o foi poss√≠vel calcular rota.", "error");
            return;
          }
          const coords = data.routes[0].geometry.coordinates;
          const latlngs = coords.map((c) => [c[1], c[0]]);
          rotaPolyline.setLatLngs(latlngs);
          const bounds = L.latLngBounds(latlngs);
          map.fitBounds(bounds, { padding: [60, 60] });
          mostrarAlerta("Rota pelas ruas tra√ßada (linha roxa).", "success");
        })
        .catch((err) => {
          console.error(err);
          mostrarAlerta("Erro ao consultar o servidor de rotas.", "error");
        });
    }

    function limparDestino() {
      destino = null;
      destinoMarker.setLatLng([-999, -999]);
      rotaPolyline.setLatLngs([]);
      document.getElementById("inputEndereco").value = "";
      mostrarAlerta("Destino removido.", "info");
    }

    function limparTrajeto() {
      if (!confirm("Limpar todo o trajeto e todas as rotas desenhadas no mapa?")) return;

      pontos = [];
      distanciaTotal = 0;
      trajetoPolyline.setLatLngs([]);

      if (rotaPolyline) rotaPolyline.setLatLngs([]);
      if (historyPolyline) {
        map.removeLayer(historyPolyline);
        historyPolyline = null;
      }

      atualizarEstatisticasUI();
      localStorage.removeItem(RASTREAMENTO_ATUAL_KEY);
      atualizarVisualizacaoRotaAtual();
      mostrarAlerta("Todas as linhas do mapa foram limpas.", "info");
    }

    function buscarEnderecoNominatim(texto) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        texto
      )}&countrycodes=br&limit=1`;

      mostrarAlerta("Buscando endere√ßo...", "info");

      fetch(url)
        .then((r) => r.json())
        .then((data) => {
          if (!data || data.length === 0) {
            mostrarAlerta("Endere√ßo n√£o encontrado.", "error");
            return;
          }
          const r0 = data[0];
          destino = { lat: parseFloat(r0.lat), lng: parseFloat(r0.lon) };
          destinoMarker.setLatLng([destino.lat, destino.lng]);
          map.setView([destino.lat, destino.lng], 17);
          mostrarAlerta(
            "Destino definido pelo endere√ßo. Clique em 'Navegar at√© destino' para rota pelas ruas.",
            "success"
          );
        })
        .catch((err) => {
          console.error(err);
          mostrarAlerta("Erro ao buscar endere√ßo.", "error");
        });
    }

    function salvarRastreamentoAtual() {
      const dados = {
        pontos,
        distanciaTotal,
        inicioMs,
        ultimaPosicao,
      };
      try {
        localStorage.setItem(RASTREAMENTO_ATUAL_KEY, JSON.stringify(dados));
      } catch (e) {
        console.error("Erro ao salvar rastreamento:", e);
      }
    }

    function verificarRastreamentoInterrompido() {
      try {
        const dados = localStorage.getItem(RASTREAMENTO_ATUAL_KEY);
        if (!dados) return;
        const obj = JSON.parse(dados);
        if (!obj.pontos || obj.pontos.length === 0) return;

        if (confirm("Rastreamento anterior encontrado. Deseja recuperar?")) {
          pontos = obj.pontos;
          distanciaTotal = obj.distanciaTotal || 0;
          inicioMs = obj.inicioMs || Date.now();
          ultimaPosicao = obj.ultimaPosicao || null;

          trajetoPolyline.setLatLngs(pontos);
          atualizarEstatisticasUI();
          atualizarVisualizacaoRotaAtual();
          mostrarAlerta("Rastreamento anterior recuperado!", "success");
        } else {
          localStorage.removeItem(RASTREAMENTO_ATUAL_KEY);
        }
      } catch (e) {
        console.error("Erro ao verificar rastreamento interrompido:", e);
      }
    }

    // Rota atual em progresso
    function atualizarVisualizacaoRotaAtual() {
      const container = document.getElementById("currentRouteContainer");
      const empty = document.getElementById("currentRouteEmpty");

      if (rastreando && pontos.length > 0) {
        container.classList.remove("hidden");
        empty.classList.add("hidden");

        document.getElementById("currentRouteDist").textContent = (distanciaTotal / 1000).toFixed(3);
        document.getElementById("currentRouteTime").textContent = formatarTempo(Date.now() - inicioMs);
        document.getElementById("currentRoutePoints").textContent = pontos.length;
      } else {
        container.classList.add("hidden");
        empty.classList.remove("hidden");
      }
    }

    window.verRotaAtual = function () {
      if (!pontos || pontos.length < 2) {
        mostrarAlerta("Nenhuma rota em progresso para visualizar.", "error");
        return;
      }

      if (historyPolyline) {
        map.removeLayer(historyPolyline);
      }

      const latlngs = pontos.map((p) => [p.lat, p.lng]);
      historyPolyline = L.polyline(latlngs, {
        color: "#00d084",
        weight: 5,
        opacity: 0.95,
      }).addTo(map);

      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds, { padding: [60, 60] });

      mostrarAlerta("Exibindo rota em progresso", "success");
    };

    window.excluirRotaAtual = function () {
      if (!confirm("Deseja realmente excluir a rota atual?")) return;

      if (rastreando) {
        mostrarAlerta("Pare o rastreamento antes de excluir a rota atual.", "error");
        return;
      }

      pontos = [];
      distanciaTotal = 0;
      trajetoPolyline.setLatLngs([]);

      if (historyPolyline) {
        map.removeLayer(historyPolyline);
        historyPolyline = null;
      }

      localStorage.removeItem(RASTREAMENTO_ATUAL_KEY);
      atualizarEstatisticasUI();
      atualizarVisualizacaoRotaAtual();
      mostrarAlerta("Rota atual exclu√≠da.", "success");
    };

    // Hist√≥rico
    function salvarRotaNoHistorico() {
      const agora = new Date();
      const nomePadrao =
        "Rota " +
        agora.toLocaleDateString("pt-BR") +
        " " +
        agora.toLocaleTimeString("pt-BR");

      const rota = {
        id: Date.now(),
        nome: nomePadrao,
        distanciaKm: (distanciaTotal / 1000).toFixed(3),
        duracaoMs: Date.now() - inicioMs,
        pontos: [...pontos],
      };

      historicoRotas.unshift(rota);
      if (historicoRotas.length > 5) {
        historicoRotas = historicoRotas.slice(0, 5);
      }

      salvarHistoricoStorage();
      renderizarHistorico();
    }

    function salvarHistoricoStorage() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(historicoRotas));
      } catch (e) {
        console.error("Erro ao salvar hist√≥rico:", e);
      }
    }

    function carregarHistorico() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) historicoRotas = JSON.parse(data);
      } catch (e) {
        historicoRotas = [];
      }
      renderizarHistorico();
    }

    function renderizarHistorico() {
      const listEl = document.getElementById("historyList");
      const countEl = document.getElementById("historyCount");

      countEl.textContent = `${historicoRotas.length} / 5`;

      if (historicoRotas.length === 0) {
        listEl.innerHTML =
          '<div class="history-empty">Nenhuma rota registrada ainda</div>';
        return;
      }

      listEl.innerHTML = historicoRotas
        .map(
          (rota) => `
        <div class="history-item">
          <input
            class="history-name-input"
            value="${rota.nome}"
            onchange="editarNomeRota(${rota.id}, this.value)"
          />
          <div class="history-meta">
            üìç ${rota.distanciaKm} km &nbsp;‚Ä¢&nbsp; ‚è±Ô∏è ${formatarTempo(
              rota.duracaoMs
            )}
          </div>
          <div class="history-buttons">
            <button class="btn-history-view" onclick="verRotaHistorico(${rota.id})">
              üëÅ Ver
            </button>
            <button class="btn-history-delete" onclick="excluirRotaHistorico(${rota.id})">
              üóë Excluir
            </button>
          </div>
        </div>
      `
        )
        .join("");
    }

    window.editarNomeRota = function (id, novoNome) {
      const rota = historicoRotas.find((r) => r.id === id);
      if (!rota) return;
      rota.nome = novoNome || rota.nome;
      salvarHistoricoStorage();
    };

    window.verRotaHistorico = function (id) {
      const rota = historicoRotas.find((r) => r.id === id);
      if (!rota || !rota.pontos || rota.pontos.length < 2) return;

      if (historyPolyline) {
        map.removeLayer(historyPolyline);
      }

      const latlngs = rota.pontos.map((p) => [p.lat, p.lng]);
      historyPolyline = L.polyline(latlngs, {
        color: "#ffa500",
        weight: 4,
        opacity: 0.9,
      }).addTo(map);

      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds, { padding: [60, 60] });

      mostrarAlerta(`Exibindo: ${rota.nome}`, "info");
    };

    window.excluirRotaHistorico = function (id) {
      if (!confirm("Deseja realmente excluir esta rota do hist√≥rico?")) return;
      historicoRotas = historicoRotas.filter((r) => r.id !== id);
      salvarHistoricoStorage();
      renderizarHistorico();
      mostrarAlerta("Rota removida do hist√≥rico.", "success");

      if (historyPolyline) {
        map.removeLayer(historyPolyline);
        historyPolyline = null;
      }
    };
  </script>
</body>
</html>
