<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Trajeto - Pol√≠cia</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDxldFv_Hq4lLJ1KSKGJQDJtVeUMdcAs-A"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #333;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        #map {
            flex: 1;
            width: 100%;
            background: #e5e3df;
        }

        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            border-right: 3px solid #0066cc;
        }

        h1 {
            color: #0066cc;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 5px rgba(0, 102, 204, 0.3);
        }

        button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .status-box {
            background: #f8f9fa;
            border-left: 4px solid #0066cc;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .status-label {
            font-weight: bold;
            color: #555;
        }

        .status-value {
            color: #0066cc;
            font-weight: bold;
        }

        .color-legend {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 15px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 2px;
            margin-right: 8px;
        }

        .favorites-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .favorite-item {
            background: #f8f9fa;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .favorite-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .favorite-button:hover {
            background: #218838;
        }

        .remove-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin-left: 5px;
        }

        .remove-button:hover {
            background: #c82333;
        }

        .error-msg {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }

        .success-msg {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
                border-right: none;
                border-bottom: 3px solid #0066cc;
            }

            #map {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <h1>üöî Rastreador</h1>

            <div class="section">
                <div class="section-title">Localiza√ß√£o Atual</div>
                <div class="status-box">
                    <div class="status-item">
                        <span class="status-label">Latitude:</span>
                        <span class="status-value" id="latitude">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Longitude:</span>
                        <span class="status-value" id="longitude">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Precis√£o:</span>
                        <span class="status-value" id="accuracy">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Velocidade:</span>
                        <span class="status-value" id="speed">--</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Buscar Endere√ßo</div>
                <label>Digite um endere√ßo ou rua:</label>
                <input type="text" id="addressInput" placeholder="Ex: Rua das Flores, Porto Alegre">
                <button class="btn-primary" onclick="searchAddress()">üîç Buscar</button>
                <div id="searchMessage"></div>
            </div>

            <div class="section">
                <div class="section-title">Coordenadas Manuais</div>
                <label>Latitude:</label>
                <input type="number" id="manualLat" placeholder="-30.0326" step="0.0001">
                <label>Longitude:</label>
                <input type="number" id="manualLng" placeholder="-51.2093" step="0.0001">
                <button class="btn-primary" onclick="goToManualLocation()">üìç Ir para Local</button>
            </div>

            <div class="section">
                <div class="section-title">Controle de Rastreamento</div>
                <button class="btn-success" onclick="startTracking()">‚ñ∂ Iniciar</button>
                <button class="btn-danger" onclick="stopTracking()">‚èπ Parar</button>
                <button class="btn-secondary" onclick="clearPath()">üóë Limpar Trajeto</button>
                <button class="btn-primary" onclick="exportToCSV()">üì• Exportar CSV</button>
            </div>

            <div class="section">
                <div class="section-title">Favoritos</div>
                <label>Nome do Local:</label>
                <input type="text" id="favoriteName" placeholder="Ex: Delegacia Centro">
                <button class="btn-primary" onclick="addFavorite()">‚≠ê Adicionar Favorito</button>
                <div class="favorites-list" id="favoritesList"></div>
            </div>

            <div class="color-legend">
                <strong>Legenda de Cores:</strong>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1f77d4;"></div>
                    <span>Trajeto percorrido</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ca02c;"></div>
                    <span>Sua posi√ß√£o atual</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d62728;"></div>
                    <span>Destino (resultado busca)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9467bd;"></div>
                    <span>Rota para destino</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let userMarker;
        let currentLocation = null;
        let pathPolyline = null;
        let pathCoordinates = [];
        let isTracking = false;
        let watchId = null;
        let searchResultsMarkers = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        function initMap() {
            const defaultLocation = { lat: -30.0326, lng: -51.2093 };

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 16,
                center: defaultLocation,
                mapTypeControl: true,
                fullscreenControl: true,
                zoomControl: true,
            });

            userMarker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                title: 'Sua Posi√ß√£o',
                icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
            });

            getCurrentLocation();
            loadFavorites();
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        updateLocationDisplay(position);
                        userMarker.setPosition(currentLocation);
                        map.panTo(currentLocation);
                    },
                    (error) => {
                        console.error('Erro ao obter localiza√ß√£o:', error);
                        alert('‚ö†Ô∏è Ative a localiza√ß√£o para usar este aplicativo');
                    }
                );
            }
        }

        function updateLocationDisplay(position) {
            document.getElementById('latitude').textContent = position.coords.latitude.toFixed(6);
            document.getElementById('longitude').textContent = position.coords.longitude.toFixed(6);
            document.getElementById('accuracy').textContent = position.coords.accuracy.toFixed(0) + 'm';
            document.getElementById('speed').textContent = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) + ' km/h' : '--';
        }

        function startTracking() {
            if (isTracking) {
                alert('‚ö†Ô∏è Rastreamento j√° est√° em andamento!');
                return;
            }

            isTracking = true;
            pathCoordinates = [];
            alert('‚úÖ Rastreamento iniciado!');

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    updateLocationDisplay(position);
                    userMarker.setPosition(currentLocation);

                    if (pathCoordinates.length === 0 || 
                        calculateDistance(pathCoordinates[pathCoordinates.length - 1], currentLocation) > 0.005) {
                        pathCoordinates.push(currentLocation);
                    }

                    updatePath();
                    map.panTo(currentLocation);
                },
                (error) => {
                    console.error('Erro no rastreamento:', error);
                }
            );
        }

        function calculateDistance(loc1, loc2) {
            const lat1 = loc1.lat * Math.PI / 180;
            const lat2 = loc2.lat * Math.PI / 180;
            const dLat = (loc2.lat - loc1.lat) * Math.PI / 180;
            const dLng = (loc2.lng - loc1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            return a;
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                alert('‚èπÔ∏è Rastreamento parado!');
            }
        }

        function updatePath() {
            if (pathPolyline) {
                pathPolyline.setPath(pathCoordinates);
            } else {
                pathPolyline = new google.maps.Polyline({
                    path: pathCoordinates,
                    geodesic: true,
                    strokeColor: '#1f77d4',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    map: map,
                });
            }
        }

        function clearPath() {
            if (confirm('Tem certeza que deseja limpar o trajeto?')) {
                pathCoordinates = [];
                if (pathPolyline) {
                    pathPolyline.setMap(null);
                    pathPolyline = null;
                }
                alert('üóëÔ∏è Trajeto limpo!');
            }
        }

        function searchAddress() {
            const address = document.getElementById('addressInput').value.trim();
            const messageDiv = document.getElementById('searchMessage');

            if (!address) {
                messageDiv.innerHTML = '<div class="error-msg">‚ö†Ô∏è Digite um endere√ßo!</div>';
                return;
            }

            messageDiv.innerHTML = '<div class="success-msg">üîç Buscando...</div>';

            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
                .then(response => response.json())
                .then(data => {
                    clearMarkers();

                    if (data.length === 0) {
                        messageDiv.innerHTML = '<div class="error-msg">‚ùå Endere√ßo n√£o encontrado!</div>';
                        return;
                    }

                    messageDiv.innerHTML = `<div class="success-msg">‚úÖ ${data.length} resultado(s) encontrado(s)</div>`;

                    data.slice(0, 5).forEach((result, index) => {
                        const lat = parseFloat(result.lat);
                        const lng = parseFloat(result.lon);

                        const marker = new google.maps.Marker({
                            position: { lat: lat, lng: lng },
                            map: map,
                            title: result.display_name,
                            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        });

                        searchResultsMarkers.push(marker);

                        if (index === 0) {
                            map.setCenter({ lat: lat, lng: lng });
                            map.setZoom(17);
                        }
                    });
                })
                .catch(error => {
                    messageDiv.innerHTML = '<div class="error-msg">‚ùå Erro na busca: ' + error.message + '</div>';
                });
        }

        function goToManualLocation() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lng = parseFloat(document.getElementById('manualLng').value);

            if (isNaN(lat) || isNaN(lng)) {
                alert('‚ùå Digite coordenadas v√°lidas!');
                return;
            }

            const location = { lat: lat, lng: lng };
            map.setCenter(location);
            map.setZoom(17);

            new google.maps.Marker({
                position: location,
                map: map,
                title: 'Local',
                icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
            });

            alert('‚úÖ Local encontrado!');
        }

        function addFavorite() {
            if (!currentLocation) {
                alert('‚ùå Localiza√ß√£o atual n√£o dispon√≠vel!');
                return;
            }

            const name = document.getElementById('favoriteName').value.trim();

            if (!name) {
                alert('‚ùå Digite um nome para o favorito!');
                return;
            }

            const favorite = {
                name: name,
                lat: currentLocation.lat,
                lng: currentLocation.lng,
                timestamp: new Date().toLocaleString('pt-BR'),
            };

            favorites.push(favorite);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            document.getElementById('favoriteName').value = '';
            loadFavorites();
            alert('‚≠ê Favorito adicionado!');
        }

        function loadFavorites() {
            const list = document.getElementById('favoritesList');
            list.innerHTML = '';

            favorites.forEach((fav, index) => {
                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.innerHTML = `
                    <div>
                        <strong>${fav.name}</strong><br>
                        <small>${fav.timestamp}</small>
                    </div>
                    <div>
                        <button class="favorite-button" onclick="goToFavorite(${index})">Ir</button>
                        <button class="remove-button" onclick="removeFavorite(${index})">√ó</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function goToFavorite(index) {
            const fav = favorites[index];
            const location = { lat: fav.lat, lng: fav.lng };
            map.setCenter(location);
            map.setZoom(17);

            new google.maps.Marker({
                position: location,
                map: map,
                title: fav.name,
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            });
        }

        function removeFavorite(index) {
            if (confirm('Remover este favorito?')) {
                favorites.splice(index, 1);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                loadFavorites();
            }
        }

        function exportToCSV() {
            if (pathCoordinates.length === 0) {
                alert('‚ùå Nenhum trajeto para exportar!');
                return;
            }

            let csv = 'Latitude,Longitude\n';
            pathCoordinates.forEach(coord => {
                csv += `${coord.lat},${coord.lng}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trajeto_${new Date().getTime()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearMarkers() {
            searchResultsMarkers.forEach(marker => marker.setMap(null));
            searchResultsMarkers = [];
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });

            initMap();
        });
    </script>
</body>
</html>
