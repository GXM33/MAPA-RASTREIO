<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Rastreamento Policial ao Vivo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      background: #f5f6fa;
      margin: 0;
      font-family: 'Segoe UI', 'Arial', sans-serif;
    }
    #app-container {
      display: flex;
      flex-wrap: wrap;
      min-height: 100vh;
    }
    #sidebar {
      width: 340px;
      background: #fff;
      border-right: 1px solid #e1e1e1;
      padding: 22px 22px 10px 18px;
      box-shadow: 2px 0 8px #eee;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      z-index: 2;
    }
    #main-title {
      margin: 0 0 12px 0;
      font-size: 1.5em;
      color: #283e56;
      font-weight: bold;
      text-shadow: 0 2px 5px #e1e1e1;
      letter-spacing: 1px;
    }
    #map {
      flex: 1 1 350px;
      min-height: 95vh;
      z-index: 1;
      box-shadow: 0 1px 8px #ccc;
    }
    .field-label {
      font-size: 0.98em;
      margin-bottom: 4px;
      font-weight: 500;
      color: #384c66;
    }
    .search-group {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    #busca {
      flex: 1 1 auto;
      padding: 7px;
      font-size: 1em;
      border: 1px solid #bbc8df;
      border-radius: 5px;
      background: #f8fafe;
      outline: none;
      transition: border .2s;
    }
    #busca:focus { border: 1.5px solid #2277e1;}

    #suggestions {
      background: #fff;
      border: 1px solid #d6e0ef;
      border-radius: 4px;
      margin-bottom: 8px;
      max-height: 120px; 
      overflow-y: auto;
      box-shadow: 0 3px 8px #dde8fc;
      position: relative;
      z-index: 14;
    }
    #suggestions div {
      padding: 6px 11px;
      font-size: 0.95em;
      cursor: pointer;
      color: #29487d;
    }
    #suggestions div:hover {
      background: #eaf1fd;
      color:#134aec;
    }
    .btns-main, .btns-secondary {
      display: flex;
      gap: 8px;
      margin-bottom:8px;
      flex-wrap: wrap;
    }
    .btn {
      background: #3376e8;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 9px 14px;
      font-size: 0.98em;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px #e1ecfa;
      transition: background 0.2s;
      display: flex; 
      align-items: center;
      gap: 6px;
    }
    .btn:hover, .btn:focus { background: #2055ae;}
    .btn-alt { background: #eceff6; color: #364676;}
    .btn-alt:hover { background: #d5def5; }
    .btn-danger { background: #e2584d;}
    .btn-danger:hover {background: #a2463a;}
    .btn-green { background: #27b176;}
    .btn-green:hover {background:#158058;}
    #status {
      display:block;
      margin: 9px 0 11px 0;
      color: #273659;
      font-size: 1.02em;
      font-weight: 600;
      background: #eaf5ff;
      padding: 7px 11px;
      border-radius: 5px;
      min-height: 20px;
      box-shadow: 0 2px 8px #f1f8fd;
    }
    .panel {
      border: 1px solid #e0e5ec;
      background: #f8fafb;
      border-radius: 8px;
      padding: 10px 8px 8px 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px #f2f7fd;
    }
    .panel-title {
      font-size: 1.08em;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #20426b;
    }
    .trajeto, .fav {
      border-bottom: 1px solid #e7eaea;
      padding: 6px 0;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.97em;
    }
    .trajeto:last-child, .fav:last-child { border-bottom: none; }
    @media (max-width: 1000px){
      #sidebar {width: 100vw; min-height: auto; border-right: none;}
      #map {min-height: 60vh;}
      #app-container {flex-direction:column;}
    }
    ::selection { background: #1973e6; color: #fff; }
  </style>
</head>
<body>
<div id="app-container">
  <div id="sidebar">
    <h1 id="main-title">
      <i class="fa-solid fa-shield-halved"></i> Rastreamento Policial ao Vivo
    </h1>

    <div class="field-label">Endereço:</div>
    <div class="search-group">
      <input type="text" id="busca" placeholder="Rua e número (ex: Rua Teste 100)" autocomplete="off"/>
      <button class="btn-alt" id="btnLimparBusca" title="Limpar"><i class="fa-solid fa-xmark"></i></button>
      <button class="btn" id="btnBuscar"><i class="fa-solid fa-magnifying-glass"></i>Buscar</button>
    </div>
    <div id="suggestions"></div>

    <div class="btns-main">
      <button class="btn" id="btnAtual"><i class="fa-solid fa-location-crosshairs"></i>Atual</button>
      <button class="btn-green" id="btnIniciar"><i class="fa-solid fa-play"></i>Iniciar</button>
      <button class="btn-danger" id="btnParar"><i class="fa-solid fa-stop"></i>Parar</button>
    </div>
    <div class="btns-secondary">
      <button class="btn-alt" id="btnExportarImg"><i class="fa-regular fa-image"></i>Imagem</button>
      <button class="btn-alt" id="btnExportarCSV"><i class="fa-solid fa-file-csv"></i>CSV</button>
      <button class="btn-alt" id="btnAddFav"><i class="fa-solid fa-star"></i>Favoritar Local Atual</button>
    </div>

    <span id="status"></span>

    <div class="panel" id="favoritos">
      <div class="panel-title"><i class="fa-solid fa-star"></i> Favoritos</div>
      <div id="fav-list"></div>
    </div>
    <div class="panel" id="historico">
      <div class="panel-title"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</div>
      <div id="hist-list"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
<script>
let map = L.map('map').setView([-30.0346, -51.2177], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marcadorAtual=false, marcadorBusca=false, polyline, isTracking=false, watchId=null, pathLatLngs=[];
let statusText = document.getElementById('status');
function setStatus(msg) { statusText.innerText = msg; }
setStatus('Localizando...');

// --- Localização automática ao abrir
function atualizaLocalizacao(zoom=true) {
  navigator.geolocation.getCurrentPosition(pos => {
    let latlng = [pos.coords.latitude, pos.coords.longitude];
    if (!marcadorAtual) marcadorAtual = L.marker(latlng,{title:"Você",icon:L.icon({ iconUrl:"https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png", iconAnchor:[12,41] })}).addTo(map);
    else marcadorAtual.setLatLng(latlng);
    if(zoom) map.setView(latlng,17);
    setStatus("Pronto para rastrear.");
  }, () => setStatus("Desativei: não foi possível acessar sua localização!"), { enableHighAccuracy:true, maximumAge:0 });
}
atualizaLocalizacao(true);
document.getElementById('btnAtual').onclick = () => { atualizaLocalizacao(true); };

// --- Rastreamento ao vivo
function iniciarRastreamento() {
  if (isTracking) return;
  isTracking = true;
  pathLatLngs = [];
  if (polyline) map.removeLayer(polyline);
  setStatus("Rastreamento AO VIVO: Ativo!");
  watchId = navigator.geolocation.watchPosition(pos => {
    let latlng = [pos.coords.latitude, pos.coords.longitude];
    if(!marcadorAtual) marcadorAtual = L.marker(latlng).addTo(map);
    else marcadorAtual.setLatLng(latlng);
    pathLatLngs.push(latlng);
    if (polyline) polyline.addLatLng(latlng);
    else polyline = L.polyline([latlng], {color: '#3376e8',weight:5}).addTo(map);
  }, () => setStatus("Erro: Não consigo rastrear."), {enableHighAccuracy:true, maximumAge:0, timeout:9000});
}

function pararRastreamento() {
  if (!isTracking) return;
  isTracking = false;
  navigator.geolocation.clearWatch(watchId);
  setStatus("Rastreamento PARADO.");
  if (polyline && polyline.getLatLngs().length > 1) {
    let historico = JSON.parse(localStorage.getItem('historicoTrajetos') || '[]');
    historico.push(polyline.getLatLngs());
    localStorage.setItem('historicoTrajetos', JSON.stringify(historico));
    desenharHistorico();
  }
}
document.getElementById('btnIniciar').onclick = ()=> { if(confirm("Ativar rastreamento ao vivo e compartilhar localização?")) iniciarRastreamento(); };
document.getElementById('btnParar').onclick = pararRastreamento;

// --- Exportar imagem do mapa
document.getElementById('btnExportarImg').onclick = ()=>{
  leafletImage(map, function(img){
    let link = document.createElement('a');
    link.href = img.toDataURL();
    link.download = "trajeto.png";
    link.click();
  });
};
// --- Exportar CSV
document.getElementById('btnExportarCSV').onclick = ()=>{
  let coords = polyline ? polyline.getLatLngs() : [];
  let csv = 'lat,lng\n'+coords.map(p=>`${p.lat},${p.lng}`).join('\n');
  let blob = new Blob([csv],{type:'text/csv'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = "trajeto.csv";
  a.click();
};

// --- Favoritos
let favoritos = JSON.parse(localStorage.getItem('favoritosMap')||'[]');
function desenharFavoritos() {
  let el = document.getElementById('fav-list'); el.innerHTML = "";
  favoritos.forEach((fav, i) => {
    let row = document.createElement('div');
    row.className = 'fav';
    row.innerHTML = `<span>${fav.nome}</span>
      <span>
        <button class="btn-alt" onclick="navegarFavorito(${i})"><i class="fa-solid fa-location-dot"></i></button>
        <button class="btn-alt" onclick="removerFavorito(${i})"><i class="fa-solid fa-trash"></i></button>
      </span>`
    el.appendChild(row);
  });
}
document.getElementById('btnAddFav').onclick = function(){
  if(!marcadorAtual) return;
  let nome = prompt("Nome para favorito (ex: Plantão Centro)?", 'Favorito '+(favoritos.length+1));
  if (!nome) return;
  favoritos.push({ nome: nome, lat: marcadorAtual.getLatLng().lat, lng: marcadorAtual.getLatLng().lng });
  localStorage.setItem('favoritosMap', JSON.stringify(favoritos));
  desenharFavoritos();
};
window.navegarFavorito = function(i) {
  let f = favoritos[i]; if(!f) return;
  map.setView([f.lat, f.lng], 18);
  if(marcadorBusca) map.removeLayer(marcadorBusca);
  marcadorBusca = L.marker([f.lat,f.lng], {icon:L.icon({iconUrl:"https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png"})}).addTo(map);
}
window.removerFavorito = function(i){
  favoritos.splice(i,1); localStorage.setItem('favoritosMap',JSON.stringify(favoritos)); desenharFavoritos();
}
desenharFavoritos();

// --- Histórico (ver, excluir)
function desenharHistorico() {
  let el = document.getElementById('hist-list');
  el.innerHTML = '';
  let historico = JSON.parse(localStorage.getItem('historicoTrajetos')||'[]');
  historico.forEach((traj, i) => {
    let div = document.createElement('div');
    div.className = "trajeto";
    div.innerHTML = `
      <span>Trajeto #${i+1}</span>
      <span>
        <button class="btn-alt" onclick="verTrajeto(${i})" title="Ver"><i class="fa-solid fa-eye"></i></button>
        <button class="btn-alt" onclick="deletarTrajeto(${i})" title="Excluir"><i class="fa-solid fa-trash"></i></button>
      </span>
    `;
    el.appendChild(div);
  });
}
window.verTrajeto = function(i) {
  let historico = JSON.parse(localStorage.getItem('historicoTrajetos')||'[]');
  if (polyline) map.removeLayer(polyline);
  polyline = L.polyline(historico[i], {color:'#27b176',weight:5}).addTo(map);
}
window.deletarTrajeto = function(i) {
  let historico = JSON.parse(localStorage.getItem('historicoTrajetos')||'[]');
  historico.splice(i,1);
  localStorage.setItem('historicoTrajetos',JSON.stringify(historico));
  desenharHistorico();
}
desenharHistorico();

// ---- Busca de endereço com sugestões
document.getElementById('busca').addEventListener('input',function(e){
  let query = e.target.value; if (query.length<3) return;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(r=>r.json()).then(res=>{
      let sugDiv = document.getElementById('suggestions');
      sugDiv.innerHTML = '';
      res.slice(0,5).forEach(s=>{
        let el = document.createElement('div');
        el.innerText = s.display_name;
        el.onclick = ()=>{ e.target.value=s.display_name; sugDiv.innerHTML=''; };
        sugDiv.appendChild(el);
      });
    });
});
document.getElementById('btnBuscar').onclick = function(){
  let query = document.getElementById('busca').value;
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
    .then(r=>r.json()).then(res=>{
      if(res.length>0){
        let s = res[0];
        let latlng = [parseFloat(s.lat), parseFloat(s.lon)];
        if(marcadorBusca) map.removeLayer(marcadorBusca);
        marcadorBusca = L.marker(latlng,{title:"Busca",icon:L.icon({ iconUrl:"https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png" })}).addTo(map);
        map.setView(latlng,18);
      } else {
        setStatus("Endereço não encontrado.");
      }
    });
};
document.getElementById('btnLimparBusca').onclick = function(){
  document.getElementById('busca').value='';
  document.getElementById('suggestions').innerHTML = '';
  if(marcadorBusca) map.removeLayer(marcadorBusca);
};
// Fim do script
</script>
