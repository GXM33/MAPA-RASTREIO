<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreador de Trajeto - Pol√≠cia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a; color: #333;
        }
        .container { display: flex; height: 100vh; }
        #map { flex: 1; width: 100%; background: #e5e3df; }
        #map.click-mode { cursor: crosshair !important; }
        .sidebar {
            width: 350px; background: white; padding: 20px;
            overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            border-right: 3px solid #0066cc;
        }
        h1 { color: #0066cc; font-size: 20px; margin-bottom: 20px; text-align: center; }
        .section { margin-bottom: 25px; }
        .section-title {
            font-size: 14px; font-weight: bold; color: #555;
            margin-bottom: 10px; text-transform: uppercase;
        }
        label {
            display: block; font-size: 12px; font-weight: 600;
            color: #666; margin-bottom: 5px;
        }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 4px; font-size: 13px;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none; border-color: #0066cc;
            box-shadow: 0 0 5px rgba(0,102,204,0.3);
        }
        button {
            width: 100%; padding: 12px; margin: 8px 0;
            border: none; border-radius: 4px; font-size: 14px;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        }
        .btn-primary { background: #0066cc; color: white; }
        .btn-primary:hover { background: #0052a3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-info { background: #17a2b8; color: white; padding: 8px; font-size: 12px; margin: 4px 0; }
        .btn-info:hover { background: #138496; }
        .status-box {
            background: #f8f9fa; border-left: 4px solid #0066cc;
            padding: 12px; margin-bottom: 15px; border-radius: 4px; font-size: 12px;
        }
        .status-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .status-label { font-weight: bold; color: #555; }
        .status-value { color: #0066cc; font-weight: bold; }
        .color-legend {
            background: #f8f9fa; border: 1px solid #ddd;
            border-radius: 4px; padding: 10px; margin-top: 15px; font-size: 12px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
        .legend-color {
            width: 15px; height: 15px; border-radius: 2px; margin-right: 8px;
        }
        .favorites-list { margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .favorite-item {
            background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center; font-size: 12px;
        }
        .favorite-button {
            background: #28a745; color: white; border: none;
            padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;
        }
        .favorite-button:hover { background: #218838; }
        .remove-button {
            background: #dc3545; color: white; border: none;
            padding: 3px 8px; border-radius: 3px; cursor: pointer;
            font-size: 10px; margin-left: 5px;
        }
        .remove-button:hover { background: #c82333; }
        .error-msg {
            background: #f8d7da; border: 1px solid #f5c6cb;
            color: #721c24; padding: 10px; border-radius: 4px;
            margin: 10px 0; font-size: 12px;
        }
        .success-msg {
            background: #d4edda; border: 1px solid #c3e6cb;
            color: #155724; padding: 10px; border-radius: 4px;
            margin: 10px 0; font-size: 12px;
        }
        .info-msg {
            background: #d1ecf1; border: 1px solid #bee5eb;
            color: #0c5460; padding: 10px; border-radius: 4px;
            margin: 10px 0; font-size: 12px;
        }
        .search-container { position: relative; }
        .autocomplete-suggestions {
            position: absolute; background: white; border: 1px solid #ddd;
            border-top: none; border-radius: 0 0 4px 4px;
            max-height: 200px; overflow-y: auto; width: 100%;
            z-index: 1000; display: none;
        }
        .autocomplete-suggestions.show { display: block; }
        .suggestion-item {
            padding: 10px; border-bottom: 1px solid #eee;
            cursor: pointer; font-size: 12px; transition: background 0.2s;
        }
        .suggestion-item:hover { background: #e8f0ff; }
        .suggestion-item:last-child { border-bottom: none; }
        .search-buttons { display: flex; gap: 5px; }
        .search-buttons button { flex: 1; margin: 0; padding: 10px; }
        .navigation-section {
            background: #e8f4f8; border: 2px solid #17a2b8;
            border-radius: 4px; padding: 12px; margin: 10px 0;
        }
        .navigation-section h4 {
            color: #17a2b8; font-size: 12px; margin-bottom: 8px;
        }
        .navigation-info { font-size: 11px; color: #555; margin-bottom: 8px; }
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar {
                width: 100%; max-height: 40vh;
                border-right: none; border-bottom: 3px solid #0066cc;
            }
            #map { height: 60vh; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <h1>üöî Rastreador</h1>

            <div class="section">
                <div class="section-title">Localiza√ß√£o Atual</div>
                <div class="status-box">
                    <div class="status-item">
                        <span class="status-label">Latitude:</span>
                        <span class="status-value" id="latitude">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Longitude:</span>
                        <span class="status-value" id="longitude">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Precis√£o:</span>
                        <span class="status-value" id="accuracy">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Velocidade:</span>
                        <span class="status-value" id="speed">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Rastreamento:</span>
                        <span class="status-value" id="trackingStatus" style="color:#dc3545;">Parado</span>
                    </div>
                </div>
                <button class="btn-info" onclick="goToCurrentLocation()">üìç Ir para Localiza√ß√£o Atual</button>
            </div>

            <div class="section">
                <div class="section-title">Buscar Endere√ßo</div>
                <label>Digite endere√ßo e n√∫mero (ex: Rua das Flores 123):</label>
                <div class="search-container">
                    <input type="text" id="addressInput" placeholder="Ex: Rua das Flores 123 Porto Alegre" autocomplete="off">
                    <div class="autocomplete-suggestions" id="suggestions"></div>
                </div>
                <div class="search-buttons">
                    <button class="btn-primary" onclick="searchAddress()">üîç Buscar</button>
                    <button class="btn-secondary" onclick="clearSearch()">‚úï Limpar</button>
                </div>
                <div id="searchMessage"></div>
            </div>

            <div id="navigationSection" class="navigation-section" style="display: none;">
                <h4>üß≠ Navega√ß√£o</h4>
                <div class="navigation-info" id="navigationInfo"></div>
                <button class="btn-primary" onclick="navigateToSearched()">üó∫Ô∏è Navegar para Endere√ßo</button>
                <button class="btn-danger" onclick="cancelNavigation()">‚ùå Cancelar</button>
            </div>

            <div class="section">
                <div class="section-title">Adicionar Local no Mapa</div>
                <label>Clique no mapa para marcar um local:</label>
                <button id="mapClickBtn" class="btn-info" onclick="toggleMapClick()">üñ±Ô∏è Ativar Modo Click</button>
                <div id="mapClickMessage"></div>
            </div>

            <div id="mapClickNavSection" class="navigation-section" style="display: none;">
                <h4>üß≠ Navega√ß√£o para Local Clicado</h4>
                <div class="navigation-info" id="mapClickInfo"></div>
                <button class="btn-primary" onclick="navigateToMapClick()">üó∫Ô∏è Navegar para Local</button>
                <button class="btn-danger" onclick="cancelMapClickNav()">‚ùå Cancelar</button>
            </div>

            <div class="section">
                <div class="section-title">Coordenadas Manuais</div>
                <label>Latitude:</label>
                <input type="number" id="manualLat" placeholder="-30.0326" step="0.0001">
                <label>Longitude:</label>
                <input type="number" id="manualLng" placeholder="-51.2093" step="0.0001">
                <button class="btn-primary" onclick="goToManualLocation()">üìç Ir para Local</button>
            </div>

            <div class="section">
                <div class="section-title">Controle de Rastreamento</div>
                <button class="btn-success" onclick="startTracking()">‚ñ∂ Iniciar</button>
                <button class="btn-danger" onclick="stopTracking()">‚èπ Parar</button>
                <button class="btn-secondary" onclick="clearPath()">üóë Limpar Trajeto</button>
                <button class="btn-primary" onclick="exportToCSV()">üì• Exportar CSV</button>
            </div>

            <div class="section">
                <div class="section-title">Favoritos</div>
                <label>Nome do Local:</label>
                <input type="text" id="favoriteName" placeholder="Ex: Delegacia Centro">
                <button class="btn-primary" onclick="addFavorite()">‚≠ê Adicionar Favorito</button>
                <div class="favorites-list" id="favoritesList"></div>
            </div>

            <div class="color-legend">
                <strong>Legenda de Cores:</strong>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1f77d4;"></div>
                    <span>Trajeto percorrido (ajustado √† rua)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #2ca02c;"></div>
                    <span>Sua posi√ß√£o atual</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #d62728;"></div>
                    <span>Endere√ßo pesquisado</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9467bd;"></div>
                    <span>Local clicado</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff00ff;"></div>
                    <span>Rota OSRM</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_API_KEY = 'SUA_GOOGLE_API_KEY_AQUI';

        let map;
        let userMarker;
        let currentLocation = null;

        // Para desenho "snap to road"
        let pathPolyline = null;
        let pathLatLngs = [];        // pontos ao longo da rua (OSRM)
        let lastTrackedPoint = null; // √∫ltimo ponto GPS usado para chamar OSRM

        // Para exportar CSV (pontos brutos de GPS)
        let pathCoordinates = [];

        let isTracking = false;
        let watchId = null;
        let hasInitialCenter = false;
        let searchResultsMarkers = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let autocompleteTimeout;
        let mapClickMode = false;
        let selectedSearchLocation = null;
        let selectedMapClickLocation = null;
        let mapClickMarker = null;
        let routePolyline = null;

        function initMap() {
            const defaultLocation = [-30.0326, -51.2093];

            map = L.map('map').setView(defaultLocation, 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
            }).addTo(map);

            userMarker = L.marker(defaultLocation, {
                title: 'Sua Posi√ß√£o',
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);

            map.on('click', function(e) {
                if (mapClickMode) {
                    handleMapClick(e.latlng);
                }
            });

            // Watch cont√≠nuo do GPS
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        updateLocationDisplay(position);
                        userMarker.setLatLng([currentLocation.lat, currentLocation.lng]);

                        if (!hasInitialCenter) {
                            map.setView([currentLocation.lat, currentLocation.lng], 16);
                            hasInitialCenter = true;
                        }

                        if (isTracking) {
                            // Salva ponto bruto para CSV
                            if (pathCoordinates.length === 0) {
                                pathCoordinates.push({ ...currentLocation });
                            } else {
                                const lastRaw = pathCoordinates[pathCoordinates.length - 1];
                                const dRaw = calculateDistanceInMeters(lastRaw, currentLocation);
                                if (dRaw >= 1) {
                                    pathCoordinates.push({ ...currentLocation });
                                }
                            }

                            // Usa OSRM para encaixar segmento na rua
                            if (!lastTrackedPoint) {
                                lastTrackedPoint = { ...currentLocation };
                            } else {
                                const dSeg = calculateDistanceInMeters(lastTrackedPoint, currentLocation);
                                if (dSeg >= 8) { // chama OSRM a cada ~8m
                                    extendRouteAlongRoad(lastTrackedPoint, currentLocation);
                                    lastTrackedPoint = { ...currentLocation };
                                }
                            }
                        }
                    },
                    (error) => {
                        console.error('Erro no rastreamento:', error);
                        if (isTracking) setTrackingStatus('erro');
                    },
                    { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
                );
            }

            loadFavorites();
        }

        function setTrackingStatus(status) {
            const el = document.getElementById('trackingStatus');
            if (!el) return;
            if (status === 'ativo') {
                el.textContent = 'Ativo';
                el.style.color = '#28a745';
            } else if (status === 'erro') {
                el.textContent = 'Erro';
                el.style.color = '#dc3545';
            } else {
                el.textContent = 'Parado';
                el.style.color = '#dc3545';
            }
        }

        function goToCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocaliza√ß√£o n√£o √© suportada neste navegador.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    updateLocationDisplay(position);
                    userMarker.setLatLng([currentLocation.lat, currentLocation.lng]);
                    map.setView([currentLocation.lat, currentLocation.lng], 16);

                    if (isTracking) {
                        if (pathCoordinates.length === 0) {
                            pathCoordinates.push({ ...currentLocation });
                        }
                        if (!lastTrackedPoint) {
                            lastTrackedPoint = { ...currentLocation };
                        }
                    }
                },
                (error) => {
                    if (error.code === 1) {
                        alert('N√£o foi poss√≠vel acessar sua localiza√ß√£o.\nAtive a permiss√£o de localiza√ß√£o para este site no navegador e tente novamente.');
                    } else {
                        alert('Erro ao obter localiza√ß√£o deste aparelho.');
                    }
                    console.error('Erro getCurrentPosition:', error);
                },
                { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
            );
        }

        function updateLocationDisplay(position) {
            document.getElementById('latitude').textContent = position.coords.latitude.toFixed(6);
            document.getElementById('longitude').textContent = position.coords.longitude.toFixed(6);
            document.getElementById('accuracy').textContent = position.coords.accuracy.toFixed(0) + 'm';
            document.getElementById('speed').textContent = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) + ' km/h' : '--';
        }

        function startTracking() {
            if (isTracking) return;
            isTracking = true;
            pathCoordinates = [];
            pathLatLngs = [];
            lastTrackedPoint = currentLocation ? { ...currentLocation } : null;
            setTrackingStatus('ativo');

            if (currentLocation) {
                pathCoordinates.push({ ...currentLocation });
                pathLatLngs.push([currentLocation.lat, currentLocation.lng]);
                updatePath();
            }
        }

        function stopTracking() {
            isTracking = false;
            lastTrackedPoint = null;
            setTrackingStatus('parado');
        }

        // usa OSRM /route para encaixar segmento na rua
        function extendRouteAlongRoad(origin, dest) {
            const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${dest.lng},${dest.lat}?overview=full&geometries=geojson`;
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (!data.routes || !data.routes.length) {
                        console.warn('OSRM n√£o retornou rota para segmento.');
                        return;
                    }
                    const coords = data.routes[0].geometry.coordinates; // [lng,lat]
                    const latlngs = coords.map(c => [c[1], c[0]]);
                    if (pathLatLngs.length === 0) {
                        pathLatLngs = latlngs;
                    } else {
                        // evita repetir o primeiro ponto
                        pathLatLngs = pathLatLngs.concat(latlngs.slice(1));
                    }
                    updatePath();
                })
                .catch(err => {
                    console.error('Erro OSRM no segmento:', err);
                });
        }

        function calculateDistanceInMeters(loc1, loc2) {
            const R = 6371000;
            const lat1 = loc1.lat * Math.PI / 180;
            const lat2 = loc2.lat * Math.PI / 180;
            const dLat = (loc2.lat - loc1.lat) * Math.PI / 180;
            const dLng = (loc2.lng - loc1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updatePath() {
            if (pathLatLngs.length === 0) {
                if (pathPolyline) {
                    map.removeLayer(pathPolyline);
                    pathPolyline = null;
                }
                return;
            }
            if (pathPolyline) {
                pathPolyline.setLatLngs(pathLatLngs);
            } else {
                pathPolyline = L.polyline(pathLatLngs, {
                    color: '#1f77d4',
                    weight: 4,
                    opacity: 0.9,
                    smoothFactor: 1.0
                }).addTo(map);
            }
        }

        function clearPath() {
            pathCoordinates = [];
            pathLatLngs = [];
            lastTrackedPoint = null;
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
                pathPolyline = null;
            }
            const msg = document.getElementById('searchMessage');
            if (msg) {
                msg.innerHTML = '<div class="info-msg">üóë Trajeto apagado.</div>';
            }
        }

        // ---------- Geocoding Google ----------

        function googleGeocode(query) {
            const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(query + ', Brasil')}&key=${GOOGLE_API_KEY}`;
            return fetch(url).then(r => r.json());
        }

        document.getElementById('addressInput').addEventListener('input', function(e) {
            const value = e.target.value.trim();
            if (value.length < 3) {
                document.getElementById('suggestions').classList.remove('show');
                return;
            }
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => {
                fetchSuggestions(value);
            }, 300);
        });

        function fetchSuggestions(query) {
            googleGeocode(query)
                .then(data => {
                    const suggestionsDiv = document.getElementById('suggestions');
                    suggestionsDiv.innerHTML = '';
                    if (!data.results || data.results.length === 0) {
                        suggestionsDiv.classList.remove('show');
                        return;
                    }
                    data.results.slice(0, 8).forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = result.formatted_address;
                        item.onclick = () => {
                            document.getElementById('addressInput').value = result.formatted_address;
                            suggestionsDiv.classList.remove('show');
                            const lat = result.geometry.location.lat;
                            const lng = result.geometry.location.lng;
                            searchAddressFromCoords(lat, lng, result.formatted_address);
                        };
                        suggestionsDiv.appendChild(item);
                    });
                    suggestionsDiv.classList.add('show');
                })
                .catch(err => console.error('Erro Google Geocoding (sugest√µes):', err));
        }

        function clearSearch() {
            document.getElementById('addressInput').value = '';
            document.getElementById('searchMessage').innerHTML = '';
            document.getElementById('suggestions').classList.remove('show');
            document.getElementById('navigationSection').style.display = 'none';
            clearMarkers();
            clearRoute();
            selectedSearchLocation = null;
        }

        function searchAddress() {
            const address = document.getElementById('addressInput').value.trim();
            const messageDiv = document.getElementById('searchMessage');
            if (!address) {
                messageDiv.innerHTML = '<div class="error-msg">‚ö†Ô∏è Digite um endere√ßo!</div>';
                return;
            }
            messageDiv.innerHTML = '<div class="success-msg">üîç Buscando...</div>';

            googleGeocode(address)
                .then(data => {
                    clearMarkers();
                    clearRoute();
                    if (!data.results || data.results.length === 0) {
                        messageDiv.innerHTML = '<div class="error-msg">‚ùå Endere√ßo n√£o encontrado!</div>';
                        return;
                    }
                    messageDiv.innerHTML = `<div class="success-msg">‚úÖ ${data.results.length} resultado(s) encontrado(s)</div>`;
                    document.getElementById('suggestions').classList.remove('show');

                    data.results.slice(0, 5).forEach((result, index) => {
                        const lat = result.geometry.location.lat;
                        const lng = result.geometry.location.lng;
                        const marker = L.marker([lat, lng], {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).bindPopup(result.formatted_address).addTo(map);
                        searchResultsMarkers.push(marker);
                        if (index === 0) {
                            map.setView([lat, lng], 17);
                            selectedSearchLocation = { lat: lat, lng: lng, name: result.formatted_address };
                            document.getElementById('navigationSection').style.display = 'block';
                            document.getElementById('navigationInfo').textContent = `Destino: ${result.formatted_address}`;
                        }
                    });
                })
                .catch(err => {
                    messageDiv.innerHTML = '<div class="error-msg">‚ùå Erro na busca (Google)</div>';
                    console.error('Erro Google Geocoding (busca):', err);
                });
        }

        function searchAddressFromCoords(lat, lng, display_name) {
            clearMarkers();
            clearRoute();
            const messageDiv = document.getElementById('searchMessage');
            messageDiv.innerHTML = `<div class="success-msg">‚úÖ Endere√ßo encontrado!</div>`;
            const marker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).bindPopup(display_name).addTo(map);
            searchResultsMarkers.push(marker);
            map.setView([lat, lng], 17);
            selectedSearchLocation = { lat: lat, lng: lng, name: display_name };
            document.getElementById('navigationSection').style.display = 'block';
            document.getElementById('navigationInfo').textContent = `Destino: ${display_name}`;
        }

        // ---------- Rotas OSRM para navega√ß√£o ----------

        function drawRoute(origin, dest) {
            clearRoute();
            const url = `https://router.project-osrm.org/route/v1/driving/${origin.lng},${origin.lat};${dest.lng},${dest.lat}?overview=full&geometries=geojson`;
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (!data.routes || !data.routes.length) {
                        alert('‚ùå N√£o foi poss√≠vel tra√ßar rota.');
                        return;
                    }
                    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                    routePolyline = L.polyline(coords, {
                        color: '#ff00ff',
                        weight: 4,
                        opacity: 0.9
                    }).addTo(map);
                    map.fitBounds(routePolyline.getBounds());
                })
                .catch(err => {
                    console.error(err);
                    alert('‚ùå Erro ao tra√ßar rota.');
                });
        }

        function clearRoute() {
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
        }

        function navigateToSearched() {
            if (!selectedSearchLocation) {
                alert('‚ùå Nenhum endere√ßo selecionado!');
                return;
            }
            if (!currentLocation) {
                alert('‚ùå Localiza√ß√£o atual n√£o dispon√≠vel!');
                return;
            }
            const distance = calculateDistanceInMeters(currentLocation, selectedSearchLocation);
            alert(`üß≠ Navegando para: ${selectedSearchLocation.name}\nüìè Dist√¢ncia (reta): ${distance.toFixed(0)} metros`);
            drawRoute(currentLocation, selectedSearchLocation);
        }

        function cancelNavigation() {
            document.getElementById('navigationSection').style.display = 'none';
            clearMarkers();
            clearRoute();
            selectedSearchLocation = null;
        }

        // ---------- Click no mapa ----------

        function handleMapClick(latlng) {
            selectedMapClickLocation = { lat: latlng.lat, lng: latlng.lng };
            if (mapClickMarker) {
                map.removeLayer(mapClickMarker);
            }
            mapClickMarker = L.marker([latlng.lat, latlng.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-purple.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            const messageDiv = document.getElementById('mapClickMessage');
            messageDiv.innerHTML = `<div class="success-msg">‚úÖ Local marcado! Lat: ${latlng.lat.toFixed(6)}, Lng: ${latlng.lng.toFixed(6)}</div>`;
            document.getElementById('mapClickNavSection').style.display = 'block';
            document.getElementById('mapClickInfo').textContent = `Local: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            mapClickMode = false;
            document.getElementById('map').classList.remove('click-mode');
            const btn = document.getElementById('mapClickBtn');
            btn.textContent = 'üñ±Ô∏è Ativar Modo Click';
        }

        function toggleMapClick() {
            mapClickMode = !mapClickMode;
            const btn = document.getElementById('mapClickBtn');
            const msgDiv = document.getElementById('mapClickMessage');
            if (mapClickMode) {
                btn.textContent = 'üñ±Ô∏è Modo Click Ativo';
                msgDiv.innerHTML = '<div class="info-msg">Clique no mapa para marcar um local.</div>';
                document.getElementById('map').classList.add('click-mode');
            } else {
                btn.textContent = 'üñ±Ô∏è Ativar Modo Click';
                msgDiv.innerHTML = '';
                document.getElementById('map').classList.remove('click-mode');
            }
        }

        function navigateToMapClick() {
            if (!selectedMapClickLocation) {
                alert('‚ùå Nenhum local selecionado!');
                return;
            }
            if (!currentLocation) {
                alert('‚ùå Localiza√ß√£o atual n√£o dispon√≠vel!');
                return;
            }
            const distance = calculateDistanceInMeters(currentLocation, selectedMapClickLocation);
            alert(`üß≠ Navegando para: ${selectedMapClickLocation.lat.toFixed(6)}, ${selectedMapClickLocation.lng.toFixed(6)}\nüìè Dist√¢ncia (reta): ${distance.toFixed(0)} metros`);
            drawRoute(currentLocation, selectedMapClickLocation);
        }

        function cancelMapClickNav() {
            document.getElementById('mapClickNavSection').style.display = 'none';
            if (mapClickMarker) {
                map.removeLayer(mapClickMarker);
                mapClickMarker = null;
            }
            selectedMapClickLocation = null;
            document.getElementById('mapClickMessage').innerHTML = '';
            clearRoute();
        }

        // ---------- Outros utilit√°rios ----------

        function goToManualLocation() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lng = parseFloat(document.getElementById('manualLng').value);
            if (isNaN(lat) || isNaN(lng)) {
                alert('‚ùå Digite coordenadas v√°lidas!');
                return;
            }
            map.setView([lat, lng], 17);
            L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).addTo(map);
            alert('‚úÖ Local encontrado!');
        }

        function addFavorite() {
            const base =
                selectedSearchLocation ||
                selectedMapClickLocation ||
                currentLocation;

            if (!base) {
                alert('‚ùå Selecione um local no mapa ou aguarde a localiza√ß√£o atual.');
                return;
            }

            const name = document.getElementById('favoriteName').value.trim();
            if (!name) {
                alert('‚ùå Digite um nome para o favorito!');
                return;
            }

            const favorite = {
                name: name,
                lat: base.lat,
                lng: base.lng,
                timestamp: new Date().toLocaleString('pt-BR'),
            };

            favorites.push(favorite);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            document.getElementById('favoriteName').value = '';
            loadFavorites();
            alert('‚≠ê Favorito adicionado!');
        }

        function loadFavorites() {
            const list = document.getElementById('favoritesList');
            list.innerHTML = '';
            favorites.forEach((fav, index) => {
                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.innerHTML = `
                    <div>
                        <strong>${fav.name}</strong><br>
                        <small>${fav.timestamp}</small>
                    </div>
                    <div>
                        <button class="favorite-button" onclick="goToFavorite(${index})">Ir</button>
                        <button class="remove-button" onclick="removeFavorite(${index})">√ó</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function goToFavorite(index) {
            const fav = favorites[index];
            if (!fav) return;

            clearMarkers();
            clearRoute();

            map.setView([fav.lat, fav.lng], 17);
            const marker = L.marker([fav.lat, fav.lng], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                })
            }).bindPopup(fav.name).addTo(map);
            searchResultsMarkers.push(marker);

            if (currentLocation) {
                drawRoute(currentLocation, { lat: fav.lat, lng: fav.lng });
            }
        }

        function removeFavorite(index) {
            if (confirm('Remover este favorito?')) {
                favorites.splice(index, 1);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                loadFavorites();
            }
        }

        function exportToCSV() {
            if (pathCoordinates.length === 0) {
                alert('‚ùå Nenhum trajeto para exportar!');
                return;
            }
            let csv = 'Latitude,Longitude\n';
            pathCoordinates.forEach(coord => {
                csv += `${coord.lat},${coord.lng}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trajeto_${new Date().getTime()}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearMarkers() {
            searchResultsMarkers.forEach(marker => {
                map.removeLayer(marker);
            });
            searchResultsMarkers = [];
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addressInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('suggestions').classList.remove('show');
                }
            });
            initMap();
        });
    </script>
</body>
</html>
