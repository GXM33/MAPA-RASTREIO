<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Rastreador de Trajeto - Navega√ß√£o em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS (CDN oficial) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f5f5f5;
      overflow: hidden;
    }

    .container {
      display: flex;
      width: 100%;
      height: 100vh;
    }

    .map-container {
      flex: 1;
      position: relative;
      background: #e0e0e0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .location-button {
      position: absolute;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      z-index: 2000;
    }

    .location-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
    }

    .sidebar {
      width: 340px;
      background: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-left: 1px solid #e0e0e0;
    }

    .sidebar-header {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .sidebar-header h1 {
      font-size: 20px;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .sidebar-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .alert {
      display: none;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      margin-bottom: 10px;
    }

    .alert.show {
      display: block;
    }

    .alert-info {
      background: #e8f4ff;
      border: 1px solid #66a3ff;
      color: #1a4f8b;
    }

    .alert-success {
      background: #e6ffed;
      border: 1px solid #34c759;
      color: #0b5e27;
    }

    .alert-error {
      background: #ffe6e6;
      border: 1px solid #ff4d4f;
      color: #a8071a;
    }

    .status-badge {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      width: 100%;
      text-align: center;
      margin-bottom: 15px;
    }

    .status-aguardando {
      background: #fff3cd;
      color: #856404;
    }

    .status-ativo {
      background: #d4edda;
      color: #155724;
    }

    .status-parado {
      background: #f8d7da;
      color: #721c24;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 2px solid #e0e0e0;
      font-size: 14px;
      font-family: inherit;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .button-group.full {
      grid-template-columns: 1fr;
    }

    .btn {
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s;
    }

    .btn-iniciar {
      background: linear-gradient(135deg, #00d084 0%, #00a86b 100%);
      color: white;
      grid-column: 1 / -1;
    }

    .btn-parar {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: white;
    }

    .btn-info {
      background: #667eea;
      color: white;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      border: 2px solid #e0e0e0;
    }

    .btn-warning {
      background: #ffa500;
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .divider {
      height: 1px;
      background: #e0e0e0;
      margin: 15px 0;
    }

    .info-panel {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid #00d4ff;
    }

    .info-panel h3 {
      font-size: 11px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 5px;
    }

    .info-panel p {
      font-size: 16px;
      font-weight: bold;
      color: #1e3c72;
      word-break: break-all;
    }

    .info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: bold;
      color: #1e3c72;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .map-container {
        height: 50%;
      }
      .sidebar {
        width: 100%;
        height: 50%;
      }
      .button-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="map-container">
      <div id="map"></div>
      <button class="location-button" id="btnCentralizar" title="Centralizar na localiza√ß√£o">üìç</button>
    </div>

    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üöó Rastreador de Trajeto</h1>
        <p>Navega√ß√£o em Tempo Real</p>
      </div>

      <div class="sidebar-content">
        <div id="alerta" class="alert alert-info"></div>

        <div id="statusBadge" class="status-badge status-aguardando">
          ‚è≥ Aguardando GPS...
        </div>

        <div class="form-group">
          <label>üìç Buscar endere√ßo (ou clique no mapa)</label>
          <input type="text" id="inputEndereco" placeholder="Ex: Rua das Flores, Porto Alegre" />
          <div id="searchResults" class="search-results"></div>
        </div>

        <div class="button-group full">
          <button class="btn btn-iniciar" id="btnIniciar">‚ñ∂ Iniciar rastreamento</button>
          <button class="btn btn-info" id="btnNavegar">üß≠ Navegar at√© destino</button>
        </div>

        <div class="button-group">
          <button class="btn btn-parar" id="btnParar" disabled>‚èπ Parar</button>
          <button class="btn btn-secondary" id="btnLimparDestino">‚úï Limpar destino</button>
        </div>

        <div class="button-group">
          <button class="btn btn-warning" id="btnLimparTrajeto">üóë Limpar trajeto</button>
        </div>

        <div class="divider"></div>

        <div class="info-panel">
          <h3>Latitude</h3>
          <p id="latitude">--</p>
        </div>

        <div class="info-panel">
          <h3>Longitude</h3>
          <p id="longitude">--</p>
        </div>

        <div class="info-row">
          <div class="stat-card">
            <div class="stat-label">Dist√¢ncia</div>
            <div class="stat-value" id="distancia">0 km</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Tempo</div>
            <div class="stat-value" id="tempo">00:00</div>
          </div>
        </div>

        <div class="info-panel">
          <h3>Pontos</h3>
          <p id="pontos">0</p>
        </div>

        <div class="info-panel">
          <h3>Status GPS</h3>
          <p id="statusGPS">Desconectado</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS (CDN oficial) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // Vari√°veis globais
    let map;
    let userMarker;
    let trajetoPolyline;
    let rotaPolyline;
    let destinoMarker;
    let rastreando = false;
    let watchId = null;
    let ultimaPosicao = null;
    let pontos = [];
    let distanciaTotal = 0;
    let inicioMs = null;
    let destino = null;

    // Inicializa mapa ao carregar a p√°gina
    window.addEventListener("load", function () {
      inicializarMapa();
      configurarBotoes();
    });

    function inicializarMapa() {
      map = L.map("map").setView([-30.0326, -51.2093], 15);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
        maxZoom: 19,
      }).addTo(map);

      trajetoPolyline = L.polyline([], {
        color: "#00d4ff",
        weight: 6,
        opacity: 0.95,
      }).addTo(map);

      rotaPolyline = L.polyline([], {
        color: "#9b59b6",
        weight: 4,
        opacity: 0.9,
      }).addTo(map);

      userMarker = L.circleMarker([-30.0326, -51.2093], {
        radius: 10,
        fillColor: "#00d084",
        color: "white",
        weight: 3,
        opacity: 1,
        fillOpacity: 1,
      }).addTo(map);

      destinoMarker = L.marker([-999, -999]).addTo(map);

      map.on("click", onMapClick);

      obterLocalizacaoInicial();
    }

    function configurarBotoes() {
      document.getElementById("btnIniciar").addEventListener("click", iniciarRastreamento);
      document.getElementById("btnParar").addEventListener("click", pararRastreamento);
      document.getElementById("btnNavegar").addEventListener("click", navegarParaDestino);
      document.getElementById("btnLimparDestino").addEventListener("click", limparDestino);
      document.getElementById("btnLimparTrajeto").addEventListener("click", limparTrajeto);

      document.getElementById("btnCentralizar").addEventListener("click", function () {
        if (ultimaPosicao) {
          map.setView([ultimaPosicao.lat, ultimaPosicao.lng], 18);
        }
      });

      // Busca simples (apenas definindo destino pelo nome, sem lista)
      const input = document.getElementById("inputEndereco");
      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          if (input.value.trim().length >= 3) {
            buscarEnderecoNominatim(input.value.trim());
          }
        }
      });
    }

    function mostrarAlerta(msg, tipo) {
      const alerta = document.getElementById("alerta");
      alerta.className = "alert";
      if (tipo === "info") alerta.classList.add("alert-info");
      if (tipo === "success") alerta.classList.add("alert-success");
      if (tipo === "error") alerta.classList.add("alert-error");
      alerta.textContent = msg;
      alerta.classList.add("show");
    }

    function limparAlerta() {
      const alerta = document.getElementById("alerta");
      alerta.classList.remove("show");
    }

    function obterLocalizacaoInicial() {
      if (!navigator.geolocation) {
        mostrarAlerta("Navegador n√£o suporta geolocaliza√ß√£o.", "error");
        return;
      }

      mostrarAlerta("Obtendo localiza√ß√£o inicial...", "info");

      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const { latitude, longitude, accuracy } = pos.coords;
          ultimaPosicao = { lat: latitude, lng: longitude };

          map.setView([latitude, longitude], 18);
          userMarker.setLatLng([latitude, longitude]);

          atualizarPosicaoUI(latitude, longitude, accuracy);
          document.getElementById("statusGPS").textContent = "‚úÖ Conectado";
          document.getElementById("statusBadge").textContent =
            "üü° Parado (pronto para rastrear)";
          document.getElementById("statusBadge").className =
            "status-badge status-aguardando";

          mostrarAlerta("Localiza√ß√£o inicial obtida. Pronto para rastrear.", "success");
          setTimeout(limparAlerta, 3000);
        },
        function (err) {
          mostrarAlerta("Erro ao obter localiza√ß√£o. Verifique as permiss√µes do navegador.", "error");
          document.getElementById("statusGPS").textContent = "‚ùå Sem GPS";
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function iniciarRastreamento() {
      if (!navigator.geolocation) {
        mostrarAlerta("Navegador n√£o suporta geolocaliza√ß√£o.", "error");
        return;
      }

      rastreando = true;
      pontos = [];
      distanciaTotal = 0;
      inicioMs = Date.now();
      document.getElementById("btnIniciar").disabled = true;
      document.getElementById("btnParar").disabled = false;
      document.getElementById("statusBadge").textContent = "üü¢ Rastreando";
      document.getElementById("statusBadge").className =
        "status-badge status-ativo";

      mostrarAlerta("Rastreamento iniciado.", "success");

      watchId = navigator.geolocation.watchPosition(
        function (pos) {
          const { latitude, longitude, accuracy, speed } = pos.coords;
          const nova = { lat: latitude, lng: longitude };

          if (ultimaPosicao) {
            const d = calcularDistancia(ultimaPosicao, nova);
            if (d > 1) {
              distanciaTotal += d;
              pontos.push(nova);
              trajetoPolyline.setLatLngs(pontos);
            }
          } else {
            pontos.push(nova);
          }

          ultimaPosicao = nova;

          userMarker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude], 18);

          atualizarPosicaoUI(latitude, longitude, accuracy);
          atualizarEstatisticasUI();
          document.getElementById("statusGPS").textContent = "‚úÖ Conectado";

          if (speed && speed > 0) {
            // poderia mostrar velocidade futuramente
          }
        },
        function (err) {
          console.error(err);
          mostrarAlerta("Erro no GPS durante rastreamento.", "error");
        },
        { enableHighAccuracy: true, timeout: 2000, maximumAge: 0 }
      );

      // Atualiza cron√¥metro
      atualizarTempoRastreamento();
    }

    function pararRastreamento() {
      rastreando = false;
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      document.getElementById("btnIniciar").disabled = false;
      document.getElementById("btnParar").disabled = true;
      document.getElementById("statusBadge").textContent = "üü° Parado";
      document.getElementById("statusBadge").className =
        "status-badge status-parado";
      mostrarAlerta("Rastreamento parado.", "info");
    }

    function atualizarTempoRastreamento() {
      if (!rastreando || !inicioMs) return;
      const ms = Date.now() - inicioMs;
      document.getElementById("tempo").textContent = formatarTempo(ms);
      requestAnimationFrame(atualizarTempoRastreamento);
    }

    function atualizarPosicaoUI(lat, lng, accuracy) {
      document.getElementById("latitude").textContent = lat.toFixed(6);
      document.getElementById("longitude").textContent = lng.toFixed(6);
    }

    function atualizarEstatisticasUI() {
      document.getElementById("distancia").textContent =
        (distanciaTotal / 1000).toFixed(3) + " km";
      document.getElementById("pontos").textContent = String(pontos.length);
    }

    function calcularDistancia(a, b) {
      const R = 6371000;
      const dLat = ((b.lat - a.lat) * Math.PI) / 180;
      const dLng = ((b.lng - a.lng) * Math.PI) / 180;
      const lat1 = (a.lat * Math.PI) / 180;
      const lat2 = (b.lat * Math.PI) / 180;

      const x =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1) * Math.cos(lat2) *
          Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
      return R * c;
    }

    function formatarTempo(ms) {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      const ss = String(s % 60).padStart(2, "0");
      const mm = String(m % 60).padStart(2, "0");
      const hh = String(h).padStart(2, "0");
      return h > 0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
    }

    // Clique no mapa define destino
    function onMapClick(e) {
      destino = { lat: e.latlng.lat, lng: e.latlng.lng };
      destinoMarker.setLatLng(e.latlng);
      rotaPolyline.setLatLngs([]);
      mostrarAlerta(
        "Destino definido no mapa. Clique em 'Navegar at√© destino' para tra√ßar rota.",
        "info"
      );
    }

    // Navegar at√© destino usando OSRM (rota real pelas ruas)
    function navegarParaDestino() {
      if (!destino) {
        mostrarAlerta("Selecione um destino clicando no mapa ou buscando endere√ßo.", "error");
        return;
      }
      if (!ultimaPosicao) {
        mostrarAlerta("Aguarde obter sua localiza√ß√£o atual.", "error");
        return;
      }

      const start = `${ultimaPosicao.lng},${ultimaPosicao.lat}`;
      const end = `${destino.lng},${destino.lat}`;
      const url = `https://router.project-osrm.org/route/v1/driving/${start};${end}?overview=full&geometries=geojson`;

      mostrarAlerta("Calculando rota pelas ruas...", "info");

      fetch(url)
        .then((r) => r.json())
        .then((data) => {
          if (!data.routes || !data.routes[0]) {
            mostrarAlerta("N√£o foi poss√≠vel calcular rota.", "error");
            return;
          }
          const coords = data.routes[0].geometry.coordinates;
          const latlngs = coords.map((c) => [c[1], c[0]]);
          rotaPolyline.setLatLngs(latlngs);
          const bounds = L.latLngBounds(latlngs);
          map.fitBounds(bounds, { padding: [60, 60] });
          mostrarAlerta("Rota pelas ruas tra√ßada (linha roxa).", "success");
        })
        .catch((err) => {
          console.error(err);
          mostrarAlerta("Erro ao consultar o servidor de rotas.", "error");
        });
    }

    function limparDestino() {
      destino = null;
      destinoMarker.setLatLng([-999, -999]);
      rotaPolyline.setLatLngs([]);
      document.getElementById("inputEndereco").value = "";
      mostrarAlerta("Destino removido.", "info");
    }

    function limparTrajeto() {
      pontos = [];
      distanciaTotal = 0;
      trajetoPolyline.setLatLngs([]);
      atualizarEstatisticasUI();
      mostrarAlerta("Trajeto limpo.", "info");
    }

    // Busca simples no Nominatim para definir destino
    function buscarEnderecoNominatim(texto) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
        texto
      )}&countrycodes=br&limit=1`;

      mostrarAlerta("Buscando endere√ßo...", "info");

      fetch(url)
        .then((r) => r.json())
        .then((data) => {
          if (!data || data.length === 0) {
            mostrarAlerta("Endere√ßo n√£o encontrado.", "error");
            return;
          }
          const r0 = data[0];
          destino = { lat: parseFloat(r0.lat), lng: parseFloat(r0.lon) };
          destinoMarker.setLatLng([destino.lat, destino.lng]);
          map.setView([destino.lat, destino.lng], 17);
          mostrarAlerta(
            "Destino definido pelo endere√ßo. Clique em 'Navegar at√© destino' para rota pelas ruas.",
            "success"
          );
        })
        .catch((err) => {
          console.error(err);
          mostrarAlerta("Erro ao buscar endere√ßo.", "error");
        });
    }
  </script>
</body>
</html>
